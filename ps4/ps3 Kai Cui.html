<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Problem Set 4 - Kai Cui</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css">
    <style>
        .table-custom {
            border-collapse: collapse;
            width: 100%;
        }

        .table-custom th,
        .table-custom td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .table-custom th {
            text-align: left;
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <div class="container">
        <br>
        <h1>Problem Set 4</h1>
        <h3><a href="mailto:kcui23@wisc.edu">Kai Cui</a></h3><br>

        <h2>Problem 1</h2>
        <h4>a.</h4>
        <div><a href="#collapseCode1a" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode1a" class="collapse">
            <pre><code class="language-r">library(tidygraph)
library(ggraph)
library(readr)
theme_set(theme_bw())

edge_data_path &lt;- "https://raw.githubusercontent.com/krisrs1128/stat992_f23/6c4130bddbdfc9ef90537c794cdca47773643752/activities/week10/political-books-edges.csv"
node_data_path &lt;- "https://raw.githubusercontent.com/krisrs1128/stat992_f23/6c4130bddbdfc9ef90537c794cdca47773643752/activities/week10/political-books-nodes.csv"
edges &lt;- read_csv(edge_data_path, col_types = "cci")
nodes &lt;- read_csv(node_data_path, col_types = "ccc")

G &lt;- tbl_graph(nodes = nodes, edges = edges)</code></pre>
        </div>

        <h4>b.</h4>
        <div><a href="#collapseCode1b" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode1b" class="collapse">
            <pre><code class="language-r">ggraph(G, layout = "nicely") +
    geom_edge_link(width = 0.2) +
    geom_node_point(aes(color = political_ideology), size = 5) +
    geom_node_text(aes(label = label), size = 2.5)</code></pre>
        </div>
        <img src="https://raw.githubusercontent.com/kcui23/stat679/main/ps4/1b.png" alt="1b" width="85%">
        <h4>c.</h4>
        <div><a href="#collapseCode1c" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode1c" class="collapse">
            <pre><code class="language-r">ggraph(G, layout = "matrix") +
    geom_edge_tile() +
    coord_fixed(xlim = c(-1, NA), ylim = c(-1, NA)) +
    geom_node_text(aes(label = label), size = 1, x = -1, nudge_y = 0.5) +
    geom_node_text(aes(label = label), y = -1, size = 1, nudge_x = -0.5, angle = 90)</code></pre>
        </div>
        <img src="https://raw.githubusercontent.com/kcui23/stat679/main/ps4/1c.png" alt="1c" width="85%">
        <ul>
            <li><b>What is easy to see in the node-link view: </b>Which books (more than two) are often recommended
                together?</li>
            <li><b>What is easy to see in the adjacency matrix: </b>Among the books recommended together with Empire,
                which ones are recommended together with Betrayal?</li>
        </ul>

        <h2>Problem 2</h2>
        <h4>a.</h4>
        <div><a href="#collapseCode2a" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode2a" class="collapse">
            <pre><code class="language-r">library(tidyverse)
library(tidytext)
library(topicmodels)

paragraphs <- read_csv("https://uwmadison.box.com/shared/static/pz1lz301ufhbedzsj9iioee77r95xz4v.csv")
word_counts <- paragraphs %>%
    unnest_tokens(word, text) %>%
    anti_join(stop_words) %>%
    count(paragraph, word)
chapters_dtm <- word_counts %>%
    cast_dtm(paragraph, word, n)
chapters_dtm</code></pre>
        </div>
        &lt;&lt;DocumentTermMatrix (documents: 1092, terms: 5655)>>
        Non-/sparse entries: 30289/6144971
        Sparsity : 100%
        Maximal term length: 17
        Weighting : term frequency (tf)
        <h4>b.</h4>
        <div><a href="#collapseCode2b" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode2b" class="collapse">
            <pre><code class="language-r">chapters_lda <- LDA(chapters_dtm, k = 6, control = list(seed = 479))
chapters_lda</code></pre>
        </div>
        A LDA_VEM topic model with 6 topics.
        <h4>c.</h4>
        <div><a href="#collapseCode2c" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode2c" class="collapse">
            <pre><code class="language-r">library(superheat)
library(ggrepel)

topics <- tidy(chapters_lda, matrix = "beta")
memberships <- tidy(chapters_lda, matrix = "gamma")
topics %>%
    arrange(topic, -beta)
memberships %>%
    arrange(document, topic)

top_terms <- topics %>%
    group_by(topic) %>%
    slice_max(beta, n = 10) %>%
    mutate(term = reorder_within(term, beta, topic))

ggplot(top_terms, aes(beta, term, fill = factor(topic))) +
    geom_col(show.legend = FALSE) +
    facet_wrap(~ topic, scales = "free") +
    scale_fill_brewer(palette = "Set2") +
    scale_y_reordered()</code></pre>
        </div>
        <img src="https://raw.githubusercontent.com/kcui23/stat679/main/ps4/2c.png" alt="2c" width="85%">
        <h4>d.</h4>
        <div><a href="#collapseCode2d" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode2d" class="collapse">
            <pre><code class="language-r">memberships <- tidy(chapters_lda, matrix = "gamma")

purest_paragraph_index <- memberships %>%
    filter(topic == 2) %>%
    arrange(desc(gamma)) %>%
    top_n(1, gamma) %>%
    pull(document)

purest_paragraph <- paragraphs$text[as.numeric(purest_paragraph_index)]
first_sentence <- unlist(strsplit(purest_paragraph, '\\. '))[1]
paste(first_sentence)

# Verify
word_counts[word_counts$paragraph==purest_paragraph_index,"word"][,1]</code></pre>
        </div>
        <p>[1] "sir william and lady lucas were speedily applied to for their consent; and it was bestowed with a most
            joyful alacrity"</p>

        <h2>Problem 3</h2>
        <h4>a.</h4>
        <div><a href="#collapseCode3a" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a>
        </div>
        <div id="collapseCode3a" class="collapse">
            <pre><code class="language-r">library(tidyverse)
library(tidymodels)

nutrients <- read_csv("https://uwmadison.box.com/shared/static/nmgouzobq5367aex45pnbzgkhm7sur63.csv")
pca_rec <- recipe(~., data = nutrients) %>%
    update_role(id, name, group, group_lumped, new_role = "id") %>%
    step_normalize(all_predictors()) %>%
    step_pca(all_predictors())
pca_prep <- prep(pca_rec)

tidy(pca_prep, 1)</code></pre>
        </div>
        <h4>b.</h4>
        <div><a href="#collapseCode3b" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a>
        </div>
        <div id="collapseCode3b" class="collapse">
            <pre><code class="language-r">ggplot(components, aes(value ,terms)) +
    geom_col(show.legend = FALSE) +
    facet_wrap(~component, nrow = 1) +
    labs(y = NULL) +
    theme(axis.text = element_text(size = 7)) +
    theme_bw()</code></pre>
        </div>
        <img src="https://raw.githubusercontent.com/kcui23/stat679/main/ps4/3b.png" alt="3b" width="85%">
        <ul>
            <li>PC1:
                <ul>
                    <li>low values: fats, nuts</li>
                    <li>high values: vegetables, drinks</li>
                </ul>
            </li>
            <li>PC2:
                <ul>
                    <li>low values: meats</li>
                    <li>high values: breads, snacks</li>
                </ul>
        </ul>
        <h4>c.</h4>
        <div><a href="#collapseCode3c" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a>
        </div>
        <div id="collapseCode3c" class="collapse">
            <pre><code class="language-r">sorted_groups <- scores %>%
    group_by(group) %>%
    summarize(average_PC2 = mean(PC2, na.rm = TRUE)) %>%
    arrange(average_PC2) %>% 
    pull(group)
paste(sorted_groups)</code></pre></div>
[1] "Fats and Oils"                     "Lamb, Veal, and Game Products"    
[3] "Sausages and Luncheon Meats"       "Beef Products"                    
[5] "Pork Products"                     "Poultry Products"                 
[7] "Finfish and Shellfish Products"    "Ethnic Foods"                     
[9] "Soups, Sauces, and Gravies"        "Nut and Seed Products"            
[11] "Restaurant Foods"                  "Dairy and Egg Products"           
[13] "Fast Foods"                        "Vegetables and Vegetable Products"
[15] "Meals, Entrees, and Sidedishes"    "Baby Foods"                       
[17] "Legumes and Legume Products"       "Fruits and Fruit Juices"          
[19] "Beverages"                         "Baked Products"                   
[21] "Cereal Grains and Pasta"           "Snacks"                           
[23] "Sweets"                            "Breakfast Cereals"                
[25] "Spices and Herbs" 
<h4>d.</h4>
<div><a href="#collapseCode3d" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a>
</div>
<div id="collapseCode3d" class="collapse">
    <pre><code class="language-r">ggplot(scores, aes(PC1, PC2, label = name)) +
    geom_point(alpha = 0.7, size = 1.5) +
facet_wrap(~reorder(group, PC2, funs = mean))</code></pre>
</div>
<img src="https://raw.githubusercontent.com/kcui23/stat679/main/ps4/3d.png" alt="3d" width="85%">
<p>My guess about the food types on PC1 was basically accurate, but PC2 was a bit unexpected. The low values of PC2 seem to be mainly Fats and Oils, and the high values are mainly Spices and Herbs.</p>

        <h2>Problem 4</h2>
        <p>If the HTML page fails to load, <a href="https://raw.githubusercontent.com/kcui23/stat679/main/ps3/4ab.jpg"
                target="_blank">click here</a> to view a screenshot of part (a) & (b), <a
                href="https://raw.githubusercontent.com/kcui23/stat679/main/ps3/4d.mov" target="_blank">click here</a>
            to view a screen recording of part (d).</p>
        <h4>a.</h4>
        <div><a href="#collapseCode4html" class="btn btn-primary" data-toggle="collapse">Show/Hide HTML code</a></div>
        <div id="collapseCode4html" class="collapse">
            <pre><code class="language-markup">&lt;!DOCTYPE html>
&lt;html>
&lt;head>
&lt;script src="https://d3js.org/d3.v7.min.js">&lt;/script>
&lt;script src="https://d3js.org/d3-selection-multi.v1.min.js">&lt;/script>
&lt;script src="https://code.jquery.com/jquery-3.6.0.slim.min.js">&lt;/script>
&lt;link rel="stylesheet" href="4.css">
&lt;/head>
    &lt;body>
        &lt;svg height=1000 width=1800>
        &lt;g id ="tree"/>
        &lt;g id="labels">
        &lt;text/>
        &lt;/g>
        &lt;/svg>
    &lt;/body>
&lt;script src="4b.js">&lt;/script>
&lt;/html></code></pre>
        </div>
        <br>
        <div><a href="#collapseCode4js" class="btn btn-primary" data-toggle="collapse">Show/Hide js code</a></div>
        <div id="collapseCode4js" class="collapse">
            <pre><code class="language-javascript">function make_tree(edges) {
const stratifier = d3.stratify()
    .id(d => d.to)
    .parentId(d => d.from);

const root = stratifier(edges);
const tree_gen = d3.tree()
    .size([1500, 800]);
return tree_gen(root);
}

function visualize(data) {
const [nodes, edges] = data;
edges.unshift({from: null, to:1, name: 'NA', date:'NA', country:'NA'});
const link_gen = d3.linkVertical()
    .x(d => d.x)
    .y(d => d.y);
const countries = new Set([
    'China', 'UnitedStates', 'Netherlands', 'Australia', 'UnitedKingdom', 
    'Singapore', 'Switzerland', 'Korea', 'Japan', 'NA'
]);

nodes.forEach(node => {
    node.country = countries.has(node.country) ? node.country : 'Other';
});

const nodes_lookup = nodes.map((node, index) => ({ ...node, ...edges[index] }));
const tree = make_tree(nodes_lookup);

const unique_countries = Array.from(new Set(nodes.map(d => d.country)));
const myColors = ['#2B2A4C', '#C70039', '#900C3F', '#581845', '#FFC300', '#DAF7A6', '#33FFCE', '#33D4FF', '#B533FF', '#A0A0A0'];
const colorScale = d3.scaleOrdinal()
    .domain(unique_countries)
    .range(myColors);

d3.select("#tree")
    .selectAll("path")
    .data(tree.links()).enter()
    .append("path")
    .attr("d", link_gen)
    .attr("transform", "translate(0, 10)");

d3.select("#tree")
    .selectAll("circle")
    .data(tree.descendants()).enter()
    .append("circle")
    .attrs({
    cx: d => d.x,
    cy: d => d.y,
    r: d => radius(d.depth),
    fill: d => colorScale(d.data.country),
    transform: "translate(0, 10)"
    });
}

function radius(depth) {
return 10 - (0.3 * depth);
}

Promise.all([
d3.csv("https://raw.githubusercontent.com/krisrs1128/stat992_f23/main/exercises/ps4/covid-nodes.csv", d3.autoType),
d3.csv("https://raw.githubusercontent.com/krisrs1128/stat992_f23/main/exercises/ps4/covid-edges.csv", d3.autoType)
]).then(visualize);
</code></pre>
        </div>
        <br>
        <iframe src="https://kcui23.github.io/stat679/ps3/4.html" width="900" height="1100"></iframe>
        <h4>c.</h4>
        <p>One possible interactivity is highlighting the time series when the a county is hovered.</p>
        <h4>d.</h4>
        <div><a href="#collapseCode4d" class="btn btn-primary" data-toggle="collapse">Show/Hide code</a></div>
        <div id="collapseCode4d" class="collapse">
            <pre><code class="language-javascript">function visualize_line(data) {
    data = parse(data);
    //draw_line(data, myscale(data));
    add_axes(myscale(data));
}

function parse(data) {
    let parse_time = d3.timeParse("%Y %b");
    let groupedData = data.reduce((acc, cur) => {
        if (cur.date === 'NA' || cur.calfresh === 'NA') {
            return acc;
        }
        cur.date = parse_time(cur.date);
        if (!acc[cur.county]) {
            acc[cur.county] = [];
        }
        acc[cur.county].push(cur);
        return acc;
    }, {});

    return Object.values(groupedData);
}

let count = 0;
function draw_line(county, data, myscale) {
    let line = d3.line()
        .x(d => myscale.x(d.date))
        .y(d => myscale.y(d.calfresh));
    
    if (count == 0) {
        d3.select("svg")
            .select("#series")
            .selectAll("path")
            .data(data, d => d.county).enter()
            .append("path")
            .attrs({
                "id": county,
                "fill": "none",
                "stroke": "darkblue",
                "stroke-width": 2,
                "d": line
            });
    }
    count++;

    let paths = d3.select("svg")
                    .select("#series")
                    .selectAll("path")
                    .data(data, d => d.county);

    paths.enter()
            .append("path")
            .attr("id", county)
            .attr("stroke", "darkblue")
            .attr("stroke-width", 2)
            .attr("fill", "none");

    paths.transition()
            .duration(500)
            .attr("d", line);

    paths.exit().remove();
}


function add_axes(myscale) {
    let x_axis = d3.axisBottom()
        .scale(myscale.x),
        y_axis = d3.axisLeft()
            .scale(myscale.y);

    d3.select("#axes")
        .append("g")
        .attrs({
            id: "x_axis",
            transform: `translate(0,${height - margins.bottom})`
        })
        .call(x_axis);

    d3.select("#axes")
        .append("g")
        .attrs({
            id: "y_axis",
            transform: `translate(${margins.left}, 0)`
        })
        .call(y_axis)
}

function myscale(data) {
    let flattenedData = data.flat();
    let y_max = d3.max(flattenedData, d => +d.calfresh),
        x_extent = d3.extent(data[0].map(d => d.date));

    return {
        x: d3.scaleTime()
            .domain(x_extent)
            .range([margins.left, width - margins.right]),
        y: d3.scaleLinear()
            .domain([0, y_max])
            .range([height - margins.bottom, margins.top])
    }
}

function updateLineChart(selectedCounty) {
    let filteredData = originalData.filter(d=> d[0].county === selectedCounty);
    updateYAxis(myscale(filteredData));
    draw_line(selectedCounty, filteredData, myscale(filteredData));
}

function updateYAxis(myscale) {
    let y_axis = d3.axisLeft().scale(myscale.y),
        yAxisElement = d3.select("#axes").selectAll("#y_axis").data([0]);
    let yAxisEnter = yAxisElement.enter().append("g").attr("id", "y_axis");
    yAxisElement = yAxisEnter.merge(yAxisElement);

    yAxisElement.transition()
        .duration(500)
        .ease(d3.easeExp)
        .call(y_axis)
        .attr("transform", `translate(${margins.left}, 0)`);
}

function updateBoerder(d) {
    d3.select("#map")
        .selectAll("path")
        .attr("stroke-width", e => e.properties.COUNTY_NAME == d.properties.COUNTY_NAME ? 2 : 0.1);
}

function visualize_choropleth(data) {
    originalData = parse(data[1]);
    data = c_parse(data);
    let proj = d3.geoMercator()
        .fitSize([600, 600], data)
    let path = d3.geoPath()
        .projection(proj);

    d3.select("#map")
        .selectAll("path")
        .data(data.features).enter()
        .append("path")
        .attrs({
            "d": d => path(d),
            "fill": d => d3.interpolateBlues(d.properties.calfresh_avg / 200000),
            "stroke-width": 0.1,
            "stroke": "black"
        })
        .on("mouseover", function(event, d) {
            let selectedCounty = d.properties.COUNTY_NAME;
            updateLineChart(selectedCounty);
            updateBoerder(d);
        })
}

function c_parse(data) {
    let geojsonData = data[0];
    let csvData = data[1];

    let calfreshAvgByCounty = {};
    csvData.forEach(function (d) {
        calfreshAvgByCounty[d.county] = calfreshAvgByCounty[d.county] || [];
        if (!isNaN(d.calfresh)) {
            calfreshAvgByCounty[d.county].push(+d.calfresh);
        }
    });

    for (let county in calfreshAvgByCounty) {
        calfreshAvgByCounty[county] = d3.mean(calfreshAvgByCounty[county]);
    }

    geojsonData.features.forEach(function (feature) {
        let county = feature.properties.COUNTY_NAME;
        feature.properties.calfresh_avg = calfreshAvgByCounty[county] || 0;
    });

    return geojsonData;
}

let width = 900,
    height = 500,
    margins = { top: 50, bottom: 50, left: 50, right: 50 }
d3.csv("https://raw.githubusercontent.com/kcui23/stat679/main/ps3/calfresh-small.csv")
    .then(visualize_line)
Promise.all([d3.json("https://raw.githubusercontent.com/kcui23/stat679/main/ps3/California_County_Boundaries.geojson"),
d3.csv("https://raw.githubusercontent.com/kcui23/stat679/main/ps3/calfresh-small.csv")])
    .then(visualize_choropleth)</code></pre>
        </div>
        <br>
        <iframe src="https://kcui23.github.io/stat679/ps3/4d.html" width="900" height="1100"></iframe>


        <h2>Problem 5</h2>
        <h4>a. <code>geom_stream</code></h4>
        <ul>
            <li><b>Role</b>: To visualize how the total number and composition of character appearances change over
                issues. </li>
            <li><b>Hypothetical use</b>: Imagine you want to describe the demographic trends of different occupations in
                a certain area.</li>
        </ul>
        <h4>b. <code>tm_lines</code></h4>
        <ul>
            <li><b>Role</b>: It is used to draw lines on a map. It is very useful for objects like rivers.</li>
            <li><b>Hypothetical use</b>: Imagine you want to describe the distribution and flow direction of rivers in a
                certain area.</li>
        </ul>
        <h4>c. <code>rast</code></h4>
        <ul>
            <li><b>Role</b>: It is used to process raster dataIt is used to process raster data. Raster data gives
                measurements along a spatial grid and may contain multiple channels. This allows this kind of data to
                efficiently represent information such as land cover. </li>
            <li><b>Hypothetical use</b>: For example, we want to know the geographical distribution of a certain plant
                in an area.</li>
        </ul>
        <h4>d. <code>geom_horizon</code></h4>
        <ul>
            <li><b>Role</b>: This function is used to create horizon plots, a type of visualization that is effective
                for displaying time series data where space is limited. It layers and colors different segments of the
                data, allowing multiple time series to be compared in a compact format.</li>
            <li><b>Hypothetical use</b>: For example, we want to compare the temperature changes in several regions
                within a year.</li>
        </ul>

        <h2>Problem 6</h2>
        <h4>a.</h4>
        <ul>
            <li><b>Description of a spacial dataset</b>: The locations of various products within a supermarket.</li>
            <li><b>Visual encodings</b>: <ul>
                    <li>Graphic Representation: Different shapes represent different types of products.</li>
                    <li>Color Coding: Different colors for different product categories.</li>
                    <li>Signage System: Specific locations of items marked on the map.</li>
                </ul>
            </li>
            <li><b>interactivity</b>: None.</li>
        </ul>
        <h4>b.</h4>
        <p><b>Questions answered by the visualization</b>: How to find a specific product, like bread, in the
            supermarket.</p>
        <p><b>Accuracy and ease of finding answers</b>: With the current design, it can be quite challenging due to the
            extensive variety of products and dense information on the map, especially for new customers.</p>
        <h4>c. Alternative visualization</h4>
        <ul>
            <li><b>Concept</b>: <ul>
                    <li>Use different colors to indicate major product categories (e.g., green for fresh produce, blue
                        for frozen foods).</li>
                    <li>The map highlights the locations of items on the customer's shopping list.</li>
                </ul>
            </li>
            <li><b>Reason for this idea</b>: A dynamic, interactive map can significantly reduce the time taken to find
                products, especially helpful for those unfamiliar with the store layout. Customers can add items to a
                shopping list in advance, knowing approximately how long they will spend in the supermarket, aiding in
                planning subsequent activities.</li>
            <li><b>Advantages</b>: Speeds up the process of finding desired products.</li>
        </ul>
        <br>
        <br>
        <br>
        <br>


    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-r.min.js"></script>
</body>

</html>